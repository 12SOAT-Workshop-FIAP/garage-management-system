
apiVersion: newrelic.com/v1alpha2
kind: Instrumentation
metadata:
  name: newrelic-instrumentation
  namespace: newrelic
spec:
  agent:
    # Values supported: dotnet, java, nodejs, python, ruby, php
    language: nodejs

    # Values supported: newrelic-java-init:latest, newrelic-dotnet-init:latest, newrelic-node-init:latest, newrelic-python-init:latest, newrelic-ruby-init:latest, newrelic-php-init:latest, newrelic-php-init:musl
    image: newrelic/newrelic-node-init:latest
    env:
      # Configure New Relic License Key
      - name: NEW_RELIC_LICENSE_KEY
        valueFrom:
          secretKeyRef:
            name: newrelic-bundle-newrelic-infrastructure
            key: license
      # Configure App Name
      - name: NEW_RELIC_APP_NAME
        value: "garage-api"

      - name: NEW_RELIC_LOG
        value: "stdout"
      - name: NEW_RELIC_NO_CONFIG_FILE
        value: "true"
      # Enable distributed tracing
      - name: NEW_RELIC_DISTRIBUTED_TRACING_ENABLED
        value: "true"
      # Set log level
      - name: NEW_RELIC_LOG_LEVEL
        value: "info"

  # Select a namespace with a specific name by using "kubernetes.io/metadata.name" label
  namespaceLabelSelector:
    matchExpressions:
      - key: "kubernetes.io/metadata.name"
        operator: "In"
        values: ["fiap-garage"]

  # Select pods containing a specific label and value
  # IMPORTANTE: Usar o label correto que est√° no deployment (app: garage-api)
  podLabelSelector:
    matchExpressions:
      - key: "app"
        operator: "In"
        values: ["garage-api"]
